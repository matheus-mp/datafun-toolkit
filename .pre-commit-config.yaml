# .pre-commit-config.yaml
#
# REQ.PROJECT: This repository SHOULD include a .pre-commit-config.yaml
#              when quality gates are required.
# REQ: Any check that can be run locally MUST be available here.
#
# WHY: Provide fast, consistent local checks aligned with upstream quality gates.
# WHY: Keep local checks compatible with repository-wide formatting rules.
#
# OBS: Formatting baselines are defined in:
#      - .editorconfig (whitespace / indentation)
#      - .gitattributes (EOL normalization)
#
# OBS: These hooks do NOT override .editorconfig or .gitattributes;
#      they only prevent common diff noise and validate repository metadata.
#
# ALT: Checks that are inherently non-local are handled upstream (CI).
#
# OPTIONAL LOCAL USAGE (no repo venv required):
#   Install uv (once, user-level).
#   uv self update
#   uvx pre-commit install
#   uvx pre-commit run --all-files
#
# NOTE: pre-commit is optional.
#       Repositories do NOT require Python, uv, or pre-commit to clone or commit.

# CI PHASES A-B-C-D:
# - Always: Always do basic checks, and assemble: install dependencies, verify environment setup
# - Baseline: Core validation (types exist, lint passes, tests pass)
# - Coverage: Generate coverage / testing reports
# - Deploy: Build package and docs (sanity checks for release readiness)

exclude: |
  (?x)^(
    \.DS_Store|
    \.coverage|
    \.ipynb_checkpoints/|
    \.mypy_cache/|
    \.nox/|
    \.pytest_cache/|
    \.ruff_cache/|
    \.tox/|
    \.venv/|
    .*\.(egg-info)/|
    build/|
    coverage\.xml|
    dist/|
    htmlcov/|
    node_modules/|
    site/
  )

repos:
  # === ALWAYS-RUN STANDARD HYGIENE HOOKS ===

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-added-large-files
        name: A1) Prevent accidental commits of large binaries

      - id: trailing-whitespace
        name: A2) Clean trailing whitespace per .editorconfig (if fail, git add and rerun)

      - id: end-of-file-fixer
        name: A3) Ensure files end with a newline per .gitattributes (if fail, git add and rerun)

      - id: mixed-line-ending
        name: A4) Normalize line endings to LF before linters (if fail, git add and rerun)
        args: [--fix=lf] # OBS: Windows working copies may be CRLF.

      - id: check-merge-conflict
        name: A5) Prevent committing merge conflicts

      - id: check-yaml
        name: A6) Validate YAML syntax
        files: \.(yml|yaml)$
        exclude: ^mkdocs\.ya?ml$ # OBS: mkdocs.yaml may include non-standard tags.

  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        name: A7) Yamllint (YAML linter)
        args: [-c, .yamllint.yml]
        files: \.(yml|yaml)$

  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.10
    hooks:
      - id: actionlint
        name: A8) Actionlint (GitHub Actions linter)
        files: ^\.github/workflows/.*\.ya?ml$

  # === LOCAL HOOKS (UV-BASED) ===
  # OBS: "uvx" installs/executes tools in an isolated way.
  # OBS: "uv run" uses the repo environment (pyproject + .venv).

  - repo: local
    hooks:
      # === BASELINE CHECKS ===

      - id: B1-validate-pyproject
        name: B1) Validate pyproject
        entry: uv run validate-pyproject pyproject.toml
        language: system
        pass_filenames: false
        files: ^pyproject\.toml$

      - id: B2-ruff-format
        name: B2) Ruff format
        entry: uv run ruff format
        language: system
        types: [python]

      - id: B3-ruff-check
        name: B3) Ruff check (lint, autofix)
        entry: uv run ruff check --fix
        language: system
        types: [python]

      # === ADVANCED CHECKS (OPT-IN) ===
      # OBS: These checks may be time-consuming or require additional setup.
      # OBS: Enable as needed for stricter quality gates.

      - id: B4-deptry
        name: B4) Deptry (dependency check)
        entry: uv run deptry .
        language: system
        pass_filenames: false

      - id: B5-pyright
        name: B5) Pyright (type checking)
        entry: uv run pyright
        language: system
        pass_filenames: false

      - id: B6-bandit
        name: B6) Bandit (security)
        entry: uv run bandit -c pyproject.toml -r src
        language: system
        pass_filenames: false

      # === TESTS ===
      # REQ.PYTHON: Test execution MUST be available and runnable as part of the standard quality gate.

      - id: C1-pytest
        name: C1) Pytest (If ALL pass, ready for git add-commit-push)
        entry: uv run python tools/run_pytest.py
        language: system
        pass_filenames: false
